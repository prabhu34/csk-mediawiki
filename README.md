# CSK MediaWiki

Steps involved in setting up a MediaWiki end-to-end, as per the instructions listed [here](https://www.mediawiki.org/wiki/Manual:Running_MediaWiki_on_Red_Hat_Linux).

## Components
Below are the components and tech stack involved in this setup.

1. Terraform for setting up the infrastructure on MS Azure
2. Chef for Configuration Management

## Assumptions

1. Terraform is setup
2. Chef Server, Chef Workstation is setup
3. MS Azure Subscription is available
4. SSH Key Pair is generated by user locally

## Prerequisites
**Azure**
1. Install Azure CLI and run `az login` for Terraform provider authentication

**Chef**
1. Checkout and switch to `./chef/cookbooks` directory
2. Download dependent cookbooks (**firewalld** and **tar**), untar them and upload to Chef Server. Alternate, use Berksfile
3. Update the values of MediaWiki configuration in `./chef/cookbooks/tw-mediawiki/attributes/default.rb`
```
default['mediawiki']['commonPass'] = "<password>" # Enter the password to login to MediaWiki
default['mediawiki']['wikiName'] = "CSK MediaWiki" # MediaWiki custom name
default['mediawiki']['wikiUserName'] = "cskadmin" # MediaWiki admin username
```
4. Upload the custom `tw-mediawiki` to Chef Server

```ruby
knife cookbook upload tw-mediawiki
```

## Usage

1. Switch to `./azurerm` directory
2. Create `terraform.tfvars` file with custom values

```
tw_username           = "vm-ssh-username"
chef_server_url       = "https://manage.chef.io/organizations/<chef-org-name>" # if managed Chef server is used
chef_server_user_name = "chef-server-username"
chef_server_user_key  = "path-to-chef-user-key" # username.pem
ssh_public_key        = "path-to-user-public-key"
ssh_key_file          = "path-to-user-private-key"

tw_rg_name     = "azure-resourcegroup-name"
tw_vnet_name   = "azure-vnet-name"
tw_subnet_name = "azure-subnet-name"
tw_vm_name     = "azure-vm-name"

tw-tags = {
  tw-app    = "mediawiki"
  tw-env    = "dev"
  installed = "terraform"
}
```
3. Run `terraform init`
4. Run `terraform plan -compact-warnings`
5. Run `terraform apply -compact-warnings`
6. Output will be the **IP Address** to access custom MediaWiki page `http://<ipaddress>:80`

## Enhancements

1. Generalize with more parameterization for scalability
2. Use of Databags to store secrets in Chef
3. SSH Key Generation within Terraform
4. Enable Continuous Integration and Deployment
5. Security

## Limitations

1. Chef Provisioner will be deprecated in future versions of Terraform

## Versions

- Terraform 0.13
- ChefDK 4.11.1
- Chef Infra Client 15.14.0
- MediaWiki 1.34
- CentOS 8
- Apache 2.4.37 (centos)
- PHP 7.2.24
- MySQL 15.1
